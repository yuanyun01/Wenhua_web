<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线购票/预约 - 城市文化产业宣传与促进平台</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 数量选择按钮样式优化 */
        #minusBtn, #plusBtn {
            cursor: pointer;
        }
        /* 表单输入框聚焦样式 */
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-building-columns me-2"></i>城市文化平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="culture.html">文化资源</a></li>
                    <li class="nav-item"><a class="nav-link" href="events.html">文化活动</a></li>
                    <li class="nav-item"><a class="nav-link" href="forum.html">互动交流</a></li>
                    <li class="nav-item"><a class="nav-link" href="statistics.html">数据统计</a></li>
                </ul>
                <div class="d-flex" id="userNav">
                    <a href="login.html" class="btn btn-outline-light me-2">登录</a>
                    <a href="register.html" class="btn btn-primary">注册</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 页面头部 -->
    <header class="py-5 bg-primary text-white">
        <div class="container text-center">
            <h1 id="ticketTitle">活动购票/预约</h1>
            <p class="lead" id="ticketSubtitle">便捷预约，畅享文化盛宴</p>
        </div>
    </header>

    <!-- 购票/预约表单 -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- 活动信息 -->
                <div class="col-md-6 mb-4 mb-md-0">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>活动信息</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <img src="https://picsum.photos/600/300?random=40" class="img-fluid rounded shadow-sm w-100" alt="活动图片">
                            </div>
                            <div class="mb-2">
                                <h4 id="eventName">非遗精品展 - 匠心传承</h4>
                            </div>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="bi bi-calendar-check text-primary me-2"></i> <strong>活动时间：</strong> <span id="eventTime">2026-02-10 至 2026-03-10</span></li>
                                <li class="mb-2"><i class="bi bi-geo-alt text-primary me-2"></i> <strong>活动地点：</strong> <span id="eventLocation">市博物馆 1号展厅</span></li>
                                <li class="mb-2"><i class="bi bi-cash-stack text-primary me-2"></i> <strong>活动费用：</strong> <span id="eventPrice" class="fw-bold text-success">免费</span></li>
                                <li class="mb-2"><i class="bi bi-people text-primary me-2"></i> <strong>剩余名额：</strong> <span id="eventQuota" class="fw-bold">286/500</span></li>
                                <li><i class="bi bi-clock text-primary me-2"></i> <strong>预约截止：</strong> 2026-02-09 18:00</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 预约/购票表单 -->
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0" id="formTitle"><i class="bi bi-ticket-detailed me-2"></i>在线预约</h5>
                        </div>
                        <div class="card-body">
                            <form id="ticketForm">
                                <div class="mb-3">
                                    <label for="contactName" class="form-label">联系人姓名</label>
                                    <input type="text" class="form-control" id="contactName" placeholder="请输入姓名" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="contactPhone" class="form-label">联系电话</label>
                                    <input type="tel" class="form-control" id="contactPhone" placeholder="请输入手机号" required>
                                    <div class="invalid-feedback" id="phoneError">请输入有效的11位手机号</div>
                                </div>
                                
                                <div class="mb-3" id="ticketTypeDiv">
                                    <label for="ticketType" class="form-label">票种选择</label>
                                    <select class="form-select" id="ticketType">
                                        <option value="free" data-price="0" selected>免费预约票</option>
                                        <option value="vip" data-price="50">VIP讲解票 (¥50/人)</option>
                                        <option value="family" data-price="120">家庭套票 (¥120/3人)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="ticketCount" class="form-label">预约/购买数量</label>
                                    <div class="input-group">
                                        <button type="button" class="btn btn-outline-secondary" id="minusBtn">-</button>
                                        <input type="number" class="form-control text-center" id="ticketCount" value="1" min="1" max="10" readonly>
                                        <button type="button" class="btn btn-outline-secondary" id="plusBtn">+</button>
                                    </div>
                                    <div class="form-text">最多可预约/购买10张</div>
                                </div>
                                
                                <div class="mb-3" id="totalPriceDiv">
                                    <label class="form-label">总计金额</label>
                                    <div class="input-group">
                                        <span class="input-group-text">¥</span>
                                        <input type="text" class="form-control" id="totalPrice" value="0.00" readonly>
                                        <span class="input-group-text">元</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="remark" class="form-label">备注 (选填)</label>
                                    <textarea class="form-control" id="remark" rows="3" placeholder="如有特殊需求，请在此说明"></textarea>
                                </div>
                                
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="agreeTicket" required>
                                    <label class="form-check-label" for="agreeTicket">
                                        我已阅读并同意<a href="#" class="text-primary">《购票/预约须知》</a>
                                    </label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100" id="submitTicketBtn">
                                    <i class="bi bi-check-circle me-2"></i>确认预约/购票
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 购票须知 -->
            <div class="card mt-5 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-exclamation-circle me-2"></i>购票/预约须知</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">1. 预约成功后，系统会发送确认短信到您的手机，请凭短信和有效证件参加活动。</li>
                        <li class="list-group-item">2. 付费活动购票成功后不支持退款，敬请谅解；免费活动如需取消预约，请提前24小时操作。</li>
                        <li class="list-group-item">3. 一人一票，儿童需凭票入场（免费活动儿童也需预约）。</li>
                        <li class="list-group-item">4. 活动当天请提前30分钟到场签到，迟到15分钟视为自动放弃。</li>
                        <li class="list-group-item">5. 禁止携带食品、饮料、易燃易爆物品等进入活动现场。</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- 支付成功模态框 -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel"><i class="bi bi-check-circle me-2"></i>操作成功</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
                    <h4 id="successTitle">预约成功！</h4>
                    <p id="successDesc" class="text-muted">我们已将确认信息发送至您的手机，请妥善保管</p>
                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>预约编号：</strong> <span id="orderNo">CZ20260206001289</span></p>
                        <p class="mb-0"><strong>联系电话：</strong> <span id="orderPhone">138****8888</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <a href="../index.html" class="btn btn-primary">返回首页</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="bi bi-building-columns me-2"></i>城市文化产业宣传与促进平台</h5>
                    <p>致力于推广城市文化，促进文化产业发展</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>© 2026 城市文化平台 版权所有</p>
                    <p>隐私政策 | 服务条款</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 全局JS -->
    <script src="js/main.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL参数获取活动信息
            initEventInfo();
            
            // 数量增减按钮事件
            initCountButtons();
            
            // 票种选择事件
            initTicketTypeChange();
            
            // 表单提交事件
            initFormSubmit();
            
            // 计算初始总价
            calculateTotalPrice();
        });

        // 从URL参数初始化活动信息
        function initEventInfo() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const eventName = urlParams.get('name') || '非遗精品展 - 匠心传承';
            const eventType = urlParams.get('type') || 'free'; // free/paid
            
            // 更新页面标题和活动信息
            document.getElementById('ticketTitle').textContent = `${eventName} - 购票/预约`;
            document.getElementById('eventName').textContent = eventName;
            
            // 根据活动类型调整显示
            if (eventType === 'paid') {
                document.getElementById('formTitle').textContent = '在线购票';
                document.getElementById('eventPrice').textContent = '¥98/人';
                document.getElementById('eventPrice').className = 'fw-bold text-primary';
            } else {
                document.getElementById('formTitle').textContent = '在线预约';
                document.getElementById('eventPrice').textContent = '免费';
                document.getElementById('eventPrice').className = 'fw-bold text-success';
            }
        }

        // 初始化数量增减按钮
        function initCountButtons() {
            const minusBtn = document.getElementById('minusBtn');
            const plusBtn = document.getElementById('plusBtn');
            const countInput = document.getElementById('ticketCount');
            
            // 减号按钮
            minusBtn.addEventListener('click', function() {
                let count = parseInt(countInput.value);
                if (count > 1) {
                    countInput.value = count - 1;
                    calculateTotalPrice();
                }
            });
            
            // 加号按钮
            plusBtn.addEventListener('click', function() {
                let count = parseInt(countInput.value);
                if (count < 10) {
                    countInput.value = count + 1;
                    calculateTotalPrice();
                }
            });
        }

        // 票种选择变更事件
        function initTicketTypeChange() {
            const ticketType = document.getElementById('ticketType');
            ticketType.addEventListener('change', calculateTotalPrice);
        }

        // 计算总价
        function calculateTotalPrice() {
            const ticketType = document.getElementById('ticketType');
            const count = parseInt(document.getElementById('ticketCount').value);
            const pricePerTicket = parseFloat(ticketType.options[ticketType.selectedIndex].dataset.price);
            
            const totalPrice = (pricePerTicket * count).toFixed(2);
            document.getElementById('totalPrice').value = totalPrice;
            
            // 显示/隐藏总价区域（免费时也显示，只是金额为0）
            document.getElementById('totalPriceDiv').style.display = 'block';
        }

        // 表单提交事件
        function initFormSubmit() {
            const ticketForm = document.getElementById('ticketForm');
            
            ticketForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 1. 检查登录状态
                const isLogin = localStorage.getItem('isLogin') === 'true';
                if (!isLogin) {
                    alert('请先登录后再进行购票/预约操作！');
                    window.location.href = 'login.html';
                    return;
                }
                
                // 2. 验证手机号
                const phone = document.getElementById('contactPhone').value.trim();
                const phoneReg = /^1[3-9]\d{9}$/;
                if (!phoneReg.test(phone)) {
                    document.getElementById('contactPhone').classList.add('is-invalid');
                    setTimeout(() => {
                        document.getElementById('contactPhone').classList.remove('is-invalid');
                    }, 3000);
                    return;
                }
                
                // 3. 获取表单数据
                const contactName = document.getElementById('contactName').value.trim();
                const ticketCount = document.getElementById('ticketCount').value;
                const totalPrice = document.getElementById('totalPrice').value;
                const remark = document.getElementById('remark').value.trim();
                
                // 4. 模拟支付/预约流程
                console.log('提交购票/预约信息：', {
                    contactName,
                    phone,
                    ticketCount,
                    totalPrice,
                    remark
                });
                
                // 5. 显示成功提示
                document.getElementById('successTitle').textContent = totalPrice == 0 ? '预约成功！' : '购票成功！';
                document.getElementById('successDesc').textContent = totalPrice == 0 
                    ? '我们已将确认信息发送至您的手机，请妥善保管'
                    : '支付已完成，确认信息已发送至您的手机';
                document.getElementById('orderPhone').textContent = phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                
                // 生成随机订单号
                const orderNo = 'CZ' + new Date().getFullYear() + 
                                (new Date().getMonth()+1).toString().padStart(2, '0') + 
                                new Date().getDate().toString().padStart(2, '0') + 
                                Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                document.getElementById('orderNo').textContent = orderNo;
                
                // 显示成功模态框
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
                // 保存订单信息到本地存储
                saveOrderInfo({
                    orderNo,
                    eventName: document.getElementById('eventName').textContent,
                    contactName,
                    phone,
                    ticketCount,
                    totalPrice,
                    createTime: new Date().toLocaleString()
                });
            });
        }

        // 保存订单信息到本地存储
        function saveOrderInfo(order) {
            let orders = JSON.parse(localStorage.getItem('userOrders') || '[]');
            orders.push(order);
            localStorage.setItem('userOrders', JSON.stringify(orders));
        }
    </script>
</body>
</html>